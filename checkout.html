<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <link rel="shortcut icon" href="images/hackware_icon.png"
                              type="image/png"/>
    <title>HackWare Hardware Rental</title>
    <script src="js/parse-1.3.4.min.js"></script>
    <script src="js/jquery-2.1.3.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/inventory.css" />
    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <script src="js/jstorage.min.js"></script>
    <script type="text/javascript" src="https://js.stripe.com/v2/"></script>
    <script type="text/javascript">
      var itemPrice = "Only available at hackathons."
      $(window).load(function() {
        var itemName = $.jStorage.get("item");
            
        //alert("this is the checkout page, and I just got this item: " +
        //itemName);
        document.getElementById("itemname").innerHTML = itemName;

        //TODO parse request to get item (id, price, etc.) and to mark it as 
        //rented if successful
        Parse.initialize("PRZCDqiKSpzjNuIGTEHj9jXKn6f1PRfAixB2nK2r", 
          "GuD81fbE4prg1RdLLmJvhLdb8CBa21imyroGrMRk");    
        var Hardware = Parse.Object.extend("Hardware");
        var query = new Parse.Query(Hardware);
        query.ascending("Name");
        query.equalTo("Name", itemName);
        query.equalTo("rented", false);
        query.find({
          success: function(results) {
            // Successfully retrieved the object.
            //alert("found this item: " + results[0].get("Name"));
	    if(results[0].get("RentalPrice") == 0){
	      document.getElementById("itemprice").innerHTML = itemPrice;
	    }else{
              itemPrice = results[0].get("RentalPrice");
              document.getElementById("itemprice").innerHTML = "$"+ itemPrice;
            }
          },
          error: function(error) {
            alert("Error: " + error.code + " " + error.message);
          }
        });
      });

      Stripe.setPublishableKey('pk_test_Z5GLMwFTwd9TUvq6Pp1ds4dg');

      function stripeResponseHandler(status, response) {
        if (response.error) {
          //re-enable the submit button
          $('.submit-button').removeAttr( "disabled");
          //show errors on the form
          $(".payment-errors").html(response.error.message);
        } else {
          var $form = $('#payment-form');
          // response contains id and card, which contains
          //additional card details
          var token = response.id;
          // Insert the token into the form so it gets submitted
          // to the server
          $form.append($('<input type="hidden" name="stripeToken" />').val(token));
          // and submit
          $form.get(0).submit();
        }
      } 
      $(document).ready(function() {
        $("#payment-form").submit(function(event) {
          // disable the submit button to prevent repeated clicks
          $('.submit-button').attr('disabled', 'disabled');
          // amount you want to charge, in cents. 1000 = $10.00, 2000 = $20.00 
          // createToken returns immediately - the supplied callback submits 
          // the form if there are no errors
		  //
		  //
		  //itemPrice is only in dollars, not in cents. need to multiply it by 100.
          var chargeAmount = itemPrice*100;
          Stripe.card.createToken({
            name: $("input[name='name']").val(),
            number: $('.card-number').val(),
            cvc: $('.card-cvc').val(),
            exp_month: $('.card-expiry-month').val(),
            exp_year: $('.card-expiry-year').val()
          }, chargeAmount, stripeResponseHandler);
          return false; //submit from callback;
        });
      });

      if (window.location.protocol === 'file:') {
        alert("stripe.js does not work when included in pages served" + 
                      " over file:// URLs. Try serving this page over a" + 
                      " webserver. Contact support@stripe.com if you need" + 
                      " assistance.");
      }
    </script>
  </head>

  <body>
    <div id="container">
      <h1>Rental Checkout</h1>
      <!-- TODO: get the name of the item clicked on previous page. use that 
        name to search the parse db for the first item that matches that name 
        that is still available for rent. get the price and set that to a var 
        to be used in -->
      <form action="/" method="POST" id="payment-form">
        <h4 id="itemname"></h4>
        <h4 id="itemprice"></h4>
        <div class="form-row">
          <label for="name" class="stripeLabel">Your Name</label>
          <input type="text" name="name" class="required" />
        </div>            
        <div class="form-row">
          <label for="email">E-mail Address</label>
          <input type="text" name="email" class="required" />
        </div>            
        <div class="form-row">
          <label>Card Number</label>
          <input type="text" maxlength="20" autocomplete="off" 
            class="card-number stripe-sensitive required" />
        </div>
        <div class="form-row">
          <label>CVC</label>
          <input type="text" maxlength="4" autocomplete="off" 
            class="card-cvc stripe-sensitive required" />
        </div>
        <div class="form-row">
          <label>Expiration (MM/YYYY)</label>
          <div class="expiry-wrapper">
            <select class="card-expiry-month stripe-sensitive required">
            </select>

            <script type="text/javascript">
            var select = $(".card-expiry-month"),
                month = new Date().getMonth() + 1;
            for (var i = 1; i <= 12; i++) {
              select.append($("<option value='"+i+"' " +
                    (month === i ? "selected" : "")+">"+i+"</option>"));
            }
            </script>
            
            <span> / </span>
            
            <select class="card-expiry-year stripe-sensitive required"></select>
            
            <script type="text/javascript">
            var select = $(".card-expiry-year"),
                year = new Date().getFullYear();

            for (var i = 0; i < 12; i++) {
              select.append($("<option value='"+(i + year)+"' " +
                    (i === 0 ? "selected" : "")+">"+(i + year)+"</option>"));
            }
            </script>
          </div>
        </div>
        <button type="button" class="submit-button">Submit Payment</button>
        <div class="payment-errors"></div>
      </form>
    </div>
  </body>
</html>
