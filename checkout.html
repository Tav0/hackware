<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <link rel="shortcut icon" href="images/hackware_icon.png"
                              type="image/png"/>
    <title>HackWare hardware rental</title>


    <script src="https://www.parsecdn.com/js/parse-1.3.4.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/inventory.css" />
    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <script type="text/javascript" src="https://js.stripe.com/v2/"></script>
    <script src="https://checkout.stripe.com/checkout.js"></script>
    <script src="js/jstorage.min.js"></script>
    <script type="text/javascript" src="https://js.stripe.com/v2/"></script>
    <script type="text/javascript">
      Stripe.setPublishableKey('YOUR_PUBLISHABLE_KEY');

      Stripe.card.createToken({
          number: $('.card-number').val(),
          cvc: $('.card-cvc').val(),
          exp_month: $('.card-expiry-month').val(),
          exp_year: $('.card-expiry-year').val()}, stripeResponseHandler);

      function stripeResponseHandler(status, response) {
        var $form = $('#payment-form');

        if (response.error) {
          // Show the errors on the form
          $form.find('.payment-errors').text(response.error.message);
          $form.find('button').prop('disabled', false);
        } else {
          // response contains id and card, which contains
          //additional card details
          var token = response.id;
          // Insert the token into the form so it gets submitted
          // to the server
          $form.append($('<input type="hidden" name="stripeToken" />').val(token));
          // and submit
          $form.get(0).submit();
        }
      }
    </script>
  </head>

  <body>
    <div id="container">
      <h1>Rental checkout</h1>
      <!-- TODO: get the name of the item clicked on previous page. use that name to search the parse db for the first item that matches that name that is still available for rent. get the price and set that to a var to be used in -->
      <form action="/" method="post" id="payment-form" style="display: none;">
        <h4 id="itemname"></h4>
        <h4 id="itemprice"></h4>
        <div class="form-row">
          <label for="name" class="stripeLabel">Your Name</label>
          <input type="text" name="name" class="required" />
        </div>            

        <div class="form-row">
          <label for="email">E-mail Address</label>
          <input type="text" name="email" class="required" />
        </div>            

        <div class="form-row">
          <label>Card Number</label>
          <input type="text" maxlength="20" autocomplete="off" class="card-number stripe-sensitive required" />
        </div>

        <div class="form-row">
          <label>CVC</label>
          <input type="text" maxlength="4" autocomplete="off" class="card-cvc stripe-sensitive required" />
        </div>

        <div class="form-row">
          <label>Expiration</label>
          <div class="expiry-wrapper">
            <select class="card-expiry-month stripe-sensitive required">
            </select>
            <script type="text/javascript">
var select = $(".card-expiry-month"),
    month = new Date().getMonth() + 1;
for (var i = 1; i <= 12; i++) {
  select.append($("<option value='"+i+"' "+(month === i ? "selected" : "")+">"+i+"</option>"))
}
            </script>
            <span> / </span>
            <select class="card-expiry-year stripe-sensitive required"></select>
            <script type="text/javascript">
var select = $(".card-expiry-year"),
    year = new Date().getFullYear();

for (var i = 0; i < 12; i++) {
  select.append($("<option value='"+(i + year)+"' "+(i === 0 ? "selected" : "")+">"+(i + year)+"</option>"))
}
            </script>
          </div>
        </div>

        <button type="submit" name="submit-button">Submit</button>
        <div class="payment-errors"></div>
      </form>
      <script>

var temp =$.jStorage.get("item");
//alert("this is the checkout page, and I just got this item: " +temp);
document.getElementById("itemname").innerHTML = temp;



//TODO parse request to get item (id, price, etc.) and to mark it as rented if successful


Parse.initialize("PRZCDqiKSpzjNuIGTEHj9jXKn6f1PRfAixB2nK2r", 
    "GuD81fbE4prg1RdLLmJvhLdb8CBa21imyroGrMRk");    
var Hardware = Parse.Object.extend("Hardware");
var query = new Parse.Query(Hardware);
query.ascending("Name");
query.equalTo("Name",temp);
query.equalTo("rented",false);
query.find({
  success: function(results) {
    // Successfully retrieved the object.
    //alert("found this item: " + results[0].get("Name"));
    document.getElementById("itemprice").innerHTML = "$"+results[0].get("Price");
  },
  error: function(error) {
    alert("Error: " + error.code + " " + error.message);
  }
});


/*
   var handler = StripeCheckout.configure({
   key: 'pk_test_BykiGXRnfAcHt4zD9DR6sPAr',
   image: '/img/documentation/checkout/marketplace.png',
   token: function(token) {
// Use the token to create the charge with a server-side script.
// You can access the token ID with `token.id`
}
});

$('#submit').on('click', function(e) {
// Open Checkout with further options
handler.open({
name: 'Demo Site',
description: '2 widgets',
amount: 2000
});
e.preventDefault();
});

// Close Checkout on page navigation
$(window).on('popstate', function() {
handler.close();
});
 */
      </script>


  </body>

</html>
